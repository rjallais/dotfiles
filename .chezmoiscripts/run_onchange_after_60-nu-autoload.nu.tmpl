#!/usr/bin/env nu
# Re-runs when mise or Nushell startup config changes
# Hash: {{ include "dot_config/mise/config.toml" | sha256sum }}{{ include "dot_config/nushell/config.nu" | sha256sum }}{{ include "dot_config/nushell/env.nu" | sha256sum }}{{ include "AppData/Roaming/nushell/config.nu" | sha256sum }}{{ include "AppData/Roaming/nushell/env.nu" | sha256sum }}

let autoload_dir = ($nu.data-dir | path join "vendor" "autoload")
mkdir $autoload_dir

print "Generating Nushell autoload scripts..."

^mise activate nu | save -f ($autoload_dir | path join "mise.nu")
mise exec starship -- starship init nu | save -f ($autoload_dir | path join "starship.nu")
mise exec zoxide -- zoxide init nushell | save -f ($autoload_dir | path join "zoxide.nu")
mise exec atuin -- atuin init nu | save -f ($autoload_dir | path join "atuin.nu")
mise exec carapace -- carapace _carapace nushell | save -f ($autoload_dir | path join "carapace.nu")

let required = ["mise.nu" "starship.nu" "zoxide.nu" "atuin.nu" "carapace.nu"]
for f in $required {
    let p = ($autoload_dir | path join $f)
    if not ($p | path exists) {
        print $"ERROR: Failed to generate ($f) at ($p)"
        exit 1
    }
}

print "Nushell autoload scripts refreshed"
